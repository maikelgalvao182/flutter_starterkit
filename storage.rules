rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function isUser(uid) { return request.auth != null && request.auth.uid == uid; }

    // Acceptable image content types (jpeg, png, heic/heif)
    function isValidImage() {
      return request.resource.contentType in [
        'image/jpeg','image/jpg','image/png','image/heic','image/heif','image/heif-sequence','image/heic-sequence'
      ];
    }

    // Acceptable video content types (mp4, mov, quicktime)
    function isValidVideo() {
      return request.resource.contentType.matches('video/.*');
    }

    // ✅ User profile images (avatars) - Multiple path patterns for compatibility
    match /users/{userId}/profile/{allPaths=**} {
      allow read: if request.auth != null; // Requer autenticação
      allow write: if isUser(userId) && isValidImage() && request.resource.size < 15 * 1024 * 1024; // 15MB image cap
      allow delete: if isUser(userId);
    }
    
    // Legacy path pattern for existing uploads
    match /Users/{userId}/{allPaths=**} {
      allow read: if request.auth != null;
      allow write: if isUser(userId) && isValidImage() && request.resource.size < 15 * 1024 * 1024;
      allow delete: if isUser(userId);
    }

    // ✅ User gallery images
    // Público APENAS para usuários autenticados (rede social)
    match /users/{userId}/gallery/{allPaths=**} {
      allow read: if request.auth != null; // Requer autenticação
      allow write: if isUser(userId) && isValidImage() && request.resource.size < 15 * 1024 * 1024; // 15MB image cap
      allow delete: if isUser(userId);
    }

    // ✅ User video uploads
    // Público APENAS para usuários autenticados (rede social)
    match /users/{userId}/videos/{allPaths=**} {
      allow read: if request.auth != null; // Requer autenticação
      allow write: if isUser(userId) && isValidVideo() && request.resource.size < 200 * 1024 * 1024; // 200MB
      allow delete: if isUser(userId);
    }

    // ✅ Event/Party images
    // Público APENAS para usuários autenticados
    match /events/{eventId}/{userId}/{allPaths=**} {
      allow read: if request.auth != null; // Requer autenticação
      allow write: if isUser(userId) && isValidImage() && request.resource.size < 10 * 1024 * 1024; // 10MB
      allow delete: if isUser(userId);
    }

    // ✅ Event cover images (imagens de capa dos eventos)
    // Apenas o criador do evento pode fazer upload
    match /events/{eventId}/cover/{allPaths=**} {
      allow read: if request.auth != null; // Qualquer usuário autenticado pode ver
      allow write: if request.auth != null && isValidImage() && request.resource.size < 15 * 1024 * 1024; // 15MB
      allow delete: if request.auth != null;
    }

    // ✅ Event participant photos (fotos enviadas pelos participantes)
    match /events/{eventId}/photos/{userId}/{allPaths=**} {
      allow read: if request.auth != null; // Qualquer usuário autenticado pode ver
      allow write: if isUser(userId) && isValidImage() && request.resource.size < 10 * 1024 * 1024; // 10MB
      allow delete: if isUser(userId);
    }

    // ✅ Chat message images
    // Apenas usuários autenticados podem visualizar mensagens
    match /messages/{userId}/{allPaths=**} {
      allow read: if request.auth != null; // Requer autenticação
      allow write: if isUser(userId) && request.resource.size < 15 * 1024 * 1024; // 15MB
      allow delete: if isUser(userId);
    }

    // ✅ Chat images (imagens de chat em geral)
    // Qualquer usuário autenticado pode fazer upload de imagens para chat
    match /chat_images/{allPaths=**} {
      allow read: if request.auth != null; // Requer autenticação
      allow write: if request.auth != null && request.resource.size < 15 * 1024 * 1024; // 15MB
      allow delete: if request.auth != null;
    }

    // Default deny
    match /{path=**} {
      allow read, write: if false;
    }
  }
}