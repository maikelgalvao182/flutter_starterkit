/// ⭐ Sistema completo de Reviews/Avaliações
/// 
/// Collections:
/// - Reviews/{reviewId}           → Reviews finalizadas
/// - PendingReviews/{pendingId}   → Reviews pendentes (aguardando resposta)
/// 
/// Nota: ReviewStats foi removido - estatísticas são calculadas dinamicamente dos Reviews

// ============================================
// Reviews finalizadas
// ============================================
match /Reviews/{reviewId} {
  // Qualquer usuário logado pode ler reviews
  allow read: if isSignedIn();
  
  // Criar review: apenas quem está fazendo a review (reviewerId)
  allow create: if isSignedIn() && 
    request.auth.uid == request.resource.data.reviewer_id;
  
  // Atualizar/deletar: apenas o autor da review
  allow update, delete: if isSignedIn() && 
    request.auth.uid == resource.data.reviewer_id;
}

// ============================================
// Reviews pendentes
// ============================================
match /PendingReviews/{pendingId} {
  // Ler: apenas o reviewer (quem deve fazer a review)
  allow read: if isSignedIn() && 
    request.auth.uid == resource.data.reviewer_id;
  
  // Criar: Cloud Functions OU Owner do evento criando review reverso para participante
  allow create: if isSignedIn() && (
    // Caso 1: Owner criando review REVERSO para participante avaliar o owner
    // O criador (request.auth.uid) deve ser o reviewee (quem será avaliado = owner)
    // E o reviewer_role deve ser 'participant' (quem VAI fazer a review)
    (request.auth.uid == request.resource.data.reviewee_id &&
     request.resource.data.reviewer_role == 'participant') ||
    
    // Caso 2: Participante criando review para outro participante
    // (futuro - permitir avaliação entre participantes)
    (request.auth.uid == request.resource.data.reviewer_id &&
     request.resource.data.reviewer_role == 'participant')
  );
  
  // Atualizar: apenas o reviewer pode:
  // 1. Marcar como dismissed
  // 2. Confirmar presença (para owners) - inclui participant_profiles
  allow update: if isSignedIn() && 
    request.auth.uid == resource.data.reviewer_id &&
    (
      // Opção 1: dismissed
      (request.resource.data.dismissed == true &&
       request.resource.data.diff(resource.data).affectedKeys()
         .hasOnly(['dismissed', 'dismissed_at'])) ||
      // Opção 2: presence_confirmed (para owners)
      // Permite: presence_confirmed, confirmed_participant_ids, participant_profiles.*
      request.resource.data.diff(resource.data).affectedKeys()
        .hasAny(['presence_confirmed', 'confirmed_participant_ids', 'participant_profiles'])
    );
  
  // Deletar: Permitido se o usuário for o reviewer (ao completar a review)
  allow delete: if isSignedIn() && 
    request.auth.uid == resource.data.reviewer_id;
}
