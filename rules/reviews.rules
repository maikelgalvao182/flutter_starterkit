/// ⭐ Sistema completo de Reviews/Avaliações
/// 
/// Collections:
/// - Reviews/{reviewId}           → Reviews finalizadas
/// - PendingReviews/{pendingId}   → Reviews pendentes (aguardando resposta)
/// - ReviewStats/{userId}         → Estatísticas agregadas por usuário

// ============================================
// Reviews finalizadas
// ============================================
match /Reviews/{reviewId} {
  // Qualquer usuário logado pode ler reviews
  allow read: if isSignedIn();
  
  // Criar review: apenas quem está fazendo a review (reviewerId)
  allow create: if isSignedIn() && 
    request.auth.uid == request.resource.data.reviewer_id;
  
  // Atualizar/deletar: apenas o autor da review
  allow update, delete: if isSignedIn() && 
    request.auth.uid == resource.data.reviewer_id;
}

// ============================================
// Reviews pendentes
// ============================================
match /PendingReviews/{pendingId} {
  // Ler: apenas o reviewer (quem deve fazer a review)
  allow read: if isSignedIn() && 
    request.auth.uid == resource.data.reviewer_id;
  
  // Criar: apenas Cloud Functions (nenhum cliente pode criar)
  allow create: if false;
  
  // Atualizar: apenas o reviewer pode:
  // 1. Marcar como dismissed
  // 2. Confirmar presença (para owners)
  allow update: if isSignedIn() && 
    request.auth.uid == resource.data.reviewer_id &&
    (
      // Opção 1: dismissed
      (request.resource.data.dismissed == true &&
       request.resource.data.diff(resource.data).affectedKeys()
         .hasOnly(['dismissed', 'dismissed_at'])) ||
      // Opção 2: presence_confirmed (para owners)
      (request.resource.data.diff(resource.data).affectedKeys()
         .hasOnly(['presence_confirmed', 'confirmed_participant_ids']))
    );
  
  // Deletar: não permitido (Cloud Functions gerencia)
  allow delete: if false;
}

// ============================================
// Estatísticas agregadas
// ============================================
match /ReviewStats/{userId} {
  // Qualquer usuário logado pode ler stats de outros
  allow read: if isSignedIn();
  
  // Criar/atualizar/deletar: apenas Cloud Functions
  allow create, update, delete: if false;
}
