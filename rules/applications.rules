/// üé´ Cole√ß√£o de aplica√ß√µes para eventos
/// Path usado no app:
/// - EventApplications/{applicationId}
///   - eventId: string
///   - userId: string
///   - status: string ("pending" | "approved" | "rejected" | "autoApproved")
///   - appliedAt: timestamp
///   - decisionAt: timestamp (opcional)

match /EventApplications/{applicationId} {
  // Helper: buscar dados do evento relacionado
  function getEvent() {
    return get(/databases/$(database)/documents/events/$(resource.data.eventId)).data;
  }
  
  function getEventFromRequest() {
    return get(/databases/$(database)/documents/events/$(request.resource.data.eventId)).data;
  }
  
  /// üìñ LEITURA:
  /// - Criador do evento pode ver TODAS as aplica√ß√µes do seu evento
  /// - Usu√°rio pode ver APENAS suas pr√≥prias aplica√ß√µes
  /// - ‚≠ê QUALQUER usu√°rio autenticado pode ver aplica√ß√µes APROVADAS (para visualizar participantes no EventCard)
  allow read: if isSignedIn() && (
    // Sou o criador do evento
    request.auth.uid == getEvent().createdBy ||
    // √â minha pr√≥pria aplica√ß√£o
    request.auth.uid == resource.data.userId ||
    // √â uma aplica√ß√£o aprovada (qualquer um pode ver para visualizar participantes)
    (resource.data.status == 'approved' || resource.data.status == 'autoApproved')
  );
  
  /// ‚úçÔ∏è CRIAR aplica√ß√£o:
  /// - Usu√°rio autenticado
  /// - userId deve ser o pr√≥prio usu√°rio
  /// - Status deve ser "pending" ou "autoApproved" baseado no privacyType
  allow create: if isSignedIn() && 
    request.resource.data.userId == request.auth.uid &&
    request.resource.data.keys().hasAll(['eventId', 'userId', 'status', 'appliedAt']) &&
    (
      (getEventFromRequest().participants.privacyType == 'open' && 
       request.resource.data.status == 'autoApproved') ||
      (getEventFromRequest().participants.privacyType == 'private' && 
       request.resource.data.status == 'pending')
    );
  
  /// ‚úèÔ∏è ATUALIZAR aplica√ß√£o:
  /// - Apenas o criador do evento pode aprovar/rejeitar
  /// - N√£o pode mudar eventId ou userId
  /// - S√≥ pode mudar de "pending" para "approved" ou "rejected"
  /// - Deve incluir decisionAt
  allow update: if isSignedIn() && 
    request.auth.uid == getEvent().createdBy &&
    request.resource.data.eventId == resource.data.eventId &&
    request.resource.data.userId == resource.data.userId &&
    resource.data.status == 'pending' &&
    (request.resource.data.status == 'approved' || 
     request.resource.data.status == 'rejected') &&
    request.resource.data.decisionAt != null;
  
  /// üóëÔ∏è DELETE: n√£o permitido
  allow delete: if false;
}
