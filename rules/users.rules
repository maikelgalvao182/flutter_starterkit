/// üë§ Cole√ß√£o principal de usu√°rios
/// Path usado no app:
/// - Users/{userId}
///   - fullName: string
///   - instagram: string
///   - jobTitle: string
///   - gender: string
///   - bio: string
///   - country: string
///   - originSource: string
///   - interests: array<string>
///   - agreeTerms: bool
///   - photoUrl: string
///   - createdAt: timestamp
///   - updatedAt: timestamp
///   - status: string ("active" | "blocked" | ...)
///   - isBlocked: bool

match /Users/{userId} {
  allow read: if isSignedIn();
  
  // Permite que o pr√≥prio usu√°rio atualize seus dados
  allow create, update, delete: if isOwner(userId);
  
  // Permite que Cloud Functions atualizem campos espec√≠ficos de rating
  // (overallRating, totalReviews, lastRatingUpdate s√£o gerenciados pela Cloud Function updateUserRating)
  allow update: if request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['overallRating', 'totalReviews', 'lastRatingUpdate']);
  
  /// üëÅÔ∏è Subcole√ß√£o de visitas ao perfil (legacy - deprecada)
  /// Path: Users/{userId}/visits/{visitId}
  match /visits/{visitId} {
    allow read: if isOwner(userId);
    allow create, update: if isSignedIn();
    allow delete: if isOwner(userId);
  }
}

/// üë• Cole√ß√£o em min√∫sculo usada em algumas partes do app
/// Path usado no app:
/// - users/{userId}
///   (espelho simplificado de Users/{userId} para o m√≥dulo de perfil/cache)

match /users/{userId} {
  allow read: if isSignedIn();
  
  // Permite que o pr√≥prio usu√°rio atualize seus dados
  allow create, update, delete: if isOwner(userId);
  
  // Permite que Cloud Functions atualizem campos espec√≠ficos de rating
  allow update: if request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['overallRating', 'totalReviews', 'lastRatingUpdate']);
  
  /// üëÅÔ∏è Subcole√ß√£o de visitas ao perfil (duplicada por compatibilidade)
  /// Path: users/{userId}/visits/{visitId}
  match /visits/{visitId} {
    allow read: if isOwner(userId);
    allow create, update: if isSignedIn();
    allow delete: if isOwner(userId);
  }
}
