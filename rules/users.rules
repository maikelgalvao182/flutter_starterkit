/// üë§ Cole√ß√£o principal de usu√°rios
/// Path usado no app:
/// - Users/{userId}
///   - fullName: string
///   - instagram: string
///   - jobTitle: string
///   - gender: string
///   - bio: string
///   - country: string
///   - originSource: string
///   - interests: array<string>
///   - agreeTerms: bool
///   - photoUrl: string
///   - createdAt: timestamp
///   - updatedAt: timestamp
///   - status: string ("active" | "blocked" | ...)
///   - isBlocked: bool
///   - overallRating: number (gerenciado por Cloud Function)
///   - totalReviews: number (gerenciado por Cloud Function)
///   - lastRatingUpdate: timestamp (gerenciado por Cloud Function)
///   - isVerified: bool (gerenciado por Cloud Function)
///   - verifiedAt: timestamp (gerenciado por Cloud Function)
///   - facialId: string (gerenciado por Cloud Function)
///   - verificationType: string (gerenciado por Cloud Function)

match /Users/{userId} {
  /// üìñ LEITURA:
  /// - Qualquer usu√°rio autenticado pode ler perfis p√∫blicos
  allow read: if isSignedIn();
  
  /// ‚úçÔ∏è CRIAR perfil (signup):
  /// - Apenas o pr√≥prio usu√°rio pode criar seu perfil
  /// - N√ÉO pode definir campos protegidos na cria√ß√£o
  allow create: if isOwner(userId) &&
    !request.resource.data.keys()
      .hasAny(['overallRating', 'totalReviews', 'lastRatingUpdate', 
               'isVerified', 'verifiedAt', 'facialId', 'verificationType',
               'vipExpiresAt', 'vipProductId', 'vipUpdatedAt', 
               'user_is_vip', 'user_is_verified', 'user_level']);
  
  /// ‚úèÔ∏è ATUALIZAR perfil:
  /// - Apenas o pr√≥prio usu√°rio pode atualizar seu perfil
  /// - N√ÉO pode alterar campos protegidos (rating, verification, VIP)
  allow update: if isOwner(userId) &&
    !request.resource.data.diff(resource.data).affectedKeys()
      .hasAny(['overallRating', 'totalReviews', 'lastRatingUpdate', 
               'isVerified', 'verifiedAt', 'facialId', 'verificationType',
               'vipExpiresAt', 'vipProductId', 'vipUpdatedAt', 
               'user_is_vip', 'user_is_verified', 'user_level']);
  
  /// ‚úèÔ∏è ATUALIZAR campos protegidos (APENAS Cloud Functions):
  /// - Campos de rating (updateUserRating Cloud Function)
  /// - Campos de verifica√ß√£o Didit (ap√≥s webhook)
  /// - Campos VIP (ap√≥s purchase/subscription)
  allow update: if request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['overallRating', 'totalReviews', 'lastRatingUpdate']) ||
    request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['isVerified', 'verifiedAt', 'facialId', 'verificationType']) ||
    request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['vipExpiresAt', 'vipProductId', 'vipUpdatedAt', 
              'user_is_vip', 'user_is_verified', 'user_level']);
  
  /// üóëÔ∏è DELETAR perfil:
  /// - Apenas o pr√≥prio usu√°rio pode deletar seu perfil
  allow delete: if isOwner(userId);
  
  /// üëÅÔ∏è Subcole√ß√£o de visitas ao perfil (legacy - deprecada)
  /// Path: Users/{userId}/visits/{visitId}
  match /visits/{visitId} {
    allow read: if isOwner(userId);
    allow create, update: if isSignedIn();
    allow delete: if isOwner(userId);
  }
}

/// üë• Cole√ß√£o em min√∫sculo usada em algumas partes do app
/// Path usado no app:
/// - users/{userId}
///   (espelho simplificado de Users/{userId} para o m√≥dulo de perfil/cache)

match /users/{userId} {
  /// üìñ LEITURA:
  /// - Qualquer usu√°rio autenticado pode ler perfis p√∫blicos
  allow read: if isSignedIn();
  
  /// ‚úçÔ∏è CRIAR perfil (signup):
  /// - Apenas o pr√≥prio usu√°rio pode criar seu perfil
  /// - N√ÉO pode definir campos protegidos na cria√ß√£o
  allow create: if isOwner(userId) &&
    !request.resource.data.keys()
      .hasAny(['overallRating', 'totalReviews', 'lastRatingUpdate',
               'isVerified', 'verifiedAt', 'facialId', 'verificationType',
               'vipExpiresAt', 'vipProductId', 'vipUpdatedAt',
               'user_is_vip', 'user_is_verified', 'user_level']);
  
  /// ‚úèÔ∏è ATUALIZAR perfil:
  /// - Apenas o pr√≥prio usu√°rio pode atualizar seu perfil
  /// - N√ÉO pode alterar campos protegidos
  allow update: if isOwner(userId) &&
    !request.resource.data.diff(resource.data).affectedKeys()
      .hasAny(['overallRating', 'totalReviews', 'lastRatingUpdate',
               'isVerified', 'verifiedAt', 'facialId', 'verificationType',
               'vipExpiresAt', 'vipProductId', 'vipUpdatedAt',
               'user_is_vip', 'user_is_verified', 'user_level']);
  
  /// ‚úèÔ∏è ATUALIZAR campos protegidos (APENAS Cloud Functions):
  allow update: if request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['overallRating', 'totalReviews', 'lastRatingUpdate']) ||
    request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['isVerified', 'verifiedAt', 'facialId', 'verificationType']) ||
    request.resource.data.diff(resource.data).affectedKeys()
    .hasOnly(['vipExpiresAt', 'vipProductId', 'vipUpdatedAt',
              'user_is_vip', 'user_is_verified', 'user_level']);
  
  /// üóëÔ∏è DELETAR perfil:
  allow delete: if isOwner(userId);
  
  /// üëÅÔ∏è Subcole√ß√£o de visitas ao perfil (duplicada por compatibilidade)
  /// Path: users/{userId}/visits/{visitId}
  match /visits/{visitId} {
    allow read: if isOwner(userId);
    allow create, update: if isSignedIn();
    allow delete: if isOwner(userId);
  }
}
