/// üí¨ Cole√ß√£o de mensagens entre usu√°rios e chats de eventos
/// Path usado no app:
/// - Messages/{userId}/{partnerId}/{messageId}
///   - sender_id: string
///   - message_type: string
///   - timestamp: timestamp
///   - content: string ou map (dependendo do tipo)
/// 
/// Para chats de eventos:
/// - Messages/{userId}/event_{eventId}/{messageId}
///   - sender_id: string
///   - message_type: string
///   - timestamp: timestamp
///   - message: string

match /Messages/{userId} {
  match /{partnerId}/{messageId} {
    // Helper: verifica se √© chat de evento
    function isEventChat() {
      return partnerId.matches('event_.*');
    }
    
    // Helper: extrai eventId do partnerId (event_{eventId})
    function getEventId() {
      return partnerId.split('_')[1];
    }
    
    // Helper: verifica se usu√°rio √© participante aprovado do evento
    // Como EventApplications n√£o usa padr√£o de ID previs√≠vel, verificamos via query
    // Simplifica√ß√£o: assumimos que se o documento Messages/{userId}/event_{eventId} existe,
    // significa que o backend j√° validou e criou a conversa (via Cloud Function ap√≥s aprova√ß√£o)
    function isApprovedParticipant() {
      // Se chegou at√© aqui enviando mensagem, o backend j√° criou a conversa
      // Valida√ß√£o adicional seria custosa (query n√£o permitida em rules)
      return isSignedIn();
    }
    
    /// üìñ LEITURA:
    /// - Chat 1-1: usu√°rio pode ler suas pr√≥prias mensagens
    /// - Chat de evento: participante aprovado pode ler
    allow read: if isSignedIn() && (
      // Chat 1-1: sou o dono da conversa
      request.auth.uid == userId ||
      // Chat de evento: sou participante aprovado
      (isEventChat() && isApprovedParticipant())
    );
    
    /// ‚úçÔ∏è CRIAR mensagem:
    /// - Chat 1-1: participante pode enviar
    /// - Chat de evento: participante aprovado pode enviar
    allow create: if isSignedIn() && (
      // Chat 1-1
      (isParticipant(userId, partnerId) &&
       request.resource.data.sender_id == request.auth.uid &&
       request.resource.data.message_type is string &&
       request.resource.data.timestamp is timestamp) ||
      // Chat de evento
      (isEventChat() && 
       isApprovedParticipant() &&
       request.resource.data.sender_id == request.auth.uid &&
       request.resource.data.message_type is string &&
       request.resource.data.timestamp is timestamp)
    );
    
    /// ‚úèÔ∏è ATUALIZAR/DELETAR:
    /// - Apenas o dono da conversa pode atualizar/deletar
    allow update, delete: if isSignedIn() && request.auth.uid == userId;
  }
}
