/// üí¨ Cole√ß√£o de conex√µes/conversas entre usu√°rios e eventos
/// Path usado no app:
/// - Connections/{userId}/Conversations/{withUserId}
///   - user_id: string (userId do outro usu√°rio ou event_{eventId})
///   - fullname: string
///   - photoUrl: string
///   - message_type: string
///   - last_message: string
///   - message_read: bool
///   - timestamp: timestamp
///   - is_event_chat: bool (opcional, true para chats de eventos)
///   - event_id: string (opcional, eventId para chats de eventos)

match /Connections/{userId} {
  // Helper para verificar se √© criador do evento
  function isEventCreator(eventId) {
    let event = get(/databases/$(database)/documents/events/$(eventId));
    return event.data.createdBy == request.auth.uid;
  }
  
  match /Conversations/{withUserId} {
    // Helper: verifica se √© conversa de evento
    function isEventConversation() {
      return withUserId.matches('event_.*');
    }
    
    // Helper: extrai eventId do withUserId (event_{eventId})
    function getEventId() {
      return withUserId.split('_')[1];
    }
    
    // Helper: verifica se usu√°rio √© participante aprovado do evento
    // Como EventApplications n√£o usa padr√£o de ID previs√≠vel, verificamos via query
    // Simplifica√ß√£o: assumimos que se o documento Connections/{userId}/Conversations/event_{eventId} existe,
    // significa que o backend j√° validou e criou a conversa (via Cloud Function ap√≥s aprova√ß√£o)
    function isApprovedParticipant() {
      // Se chegou at√© aqui, o backend j√° criou a conversa
      return isSignedIn();
    }
    
    /// üìñ LEITURA:
    /// - Conversa 1-1: usu√°rio pode ler suas pr√≥prias conversas
    /// - Conversa de evento: participante aprovado pode ler
    allow read: if isSignedIn() && (
      // Conversa 1-1: sou o dono
      request.auth.uid == userId ||
      // Conversa de evento: sou participante aprovado
      (isEventConversation() && request.auth.uid == userId && isApprovedParticipant())
    );
    
    /// ‚úçÔ∏è CRIAR/ATUALIZAR:
    /// - Conversa 1-1: ambos participantes podem criar/atualizar
    /// - Conversa de evento: participante aprovado pode criar/atualizar sua pr√≥pria conversa
    allow create, update: if isSignedIn() && (
      // Conversa 1-1: sou participante
      isParticipant(userId, withUserId) ||
      // Conversa de evento: sou o dono e sou participante aprovado
      (isEventConversation() && request.auth.uid == userId && isApprovedParticipant())
    );
    
    /// üóëÔ∏è DELETAR:
    /// - Dono pode deletar sua pr√≥pria conversa
    /// - Criador do evento pode deletar conversas de evento ao deletar o evento
    allow delete: if isSignedIn() && (
      request.auth.uid == userId ||
      (isEventConversation() && isEventCreator(getEventId()))
    );
  }
}
